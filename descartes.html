<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descartar - Sistema de Registro</title>

    <script>
        /* Aplica el modo oscuro almacenado antes de dibujar la interfaz para evitar cambios bruscos. */
        (function() {
            try {
                const theme = localStorage.getItem('theme');
                if (theme === 'dark') {
                    document.documentElement.classList.add('dark-mode');
                }
            } catch (e) {
                /* Continuamos con el tema por defecto si el almacenamiento no responde. */
            }
        })();
    </script>

    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/descartes.css">

    <link rel="icon" href="assets/icons/icon-192.png">
    <link rel="manifest" href="manifest.json">
</head>
<body class="page-descartes-inicio">
    <!-- Espacio reservado para la barra de navegación importada -->
    <div id="navbar-placeholder"></div>

    <div id="loader" class="loader-wrapper">
        <div class="loader"></div>
    </div>

    <main id="main-content" style="display: none;">
        <div class="container">
            <div class="page-heading">
                <h1>
                    <span class="text-variant--desktop text-variant--block">Registro de Descartes</span>
                    <span class="text-variant--mobile text-variant--block">Descartes</span>
                </h1>
                <p id="descartes-description" class="page-description">
                    <span class="text-variant--desktop text-variant--block">Registra equipos descartados.</span>
                    <span class="text-variant--mobile text-variant--block">Inicia sesiones de descarte.</span>
                </p>
            </div>

            <!-- Bloque inicial para iniciar sesiones cuando no hay una activa -->
            <div id="inicio-descarte-section" class="content-center">
                <button id="btn-iniciar-descarte" class="btn-iniciar button-with-icon">
                    <span class="icon icon--sm icon-plus" aria-hidden="true"></span>
                    <span class="button-label">Iniciar Nuevo Descarte</span>
                </button>
            </div>

            <!-- Formulario completo para registrar equipos dentro de una sesión activa -->
            <div id="registro-equipos-section" class="content-center" style="display: none;">

                <h4 class="session-indicator">
                    Registrando equipos para la Sesión #<span id="active-session-id"></span>
                </h4>

                <form id="form-equipo" class="form-equipo" novalidate>
                    <h2>Añadir Equipo</h2>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="descripcion">Descripción:</label>
                            <input type="text" id="descripcion" placeholder="Ej: CPU, Monitor...">
                        </div>
                        
                        <div class="form-group">
                            <label for="marbete">Marbete:</label>
                            <div class="input-with-button">
                                <input type="text" id="marbete" placeholder="Número de marbete">
                                <button type="button" class="btn-scan button-with-icon" data-target-input="marbete">
                                    <span class="icon icon--sm icon-scan" aria-hidden="true"></span>
                                    <span class="sr-only">Escanear marbete</span>
                                </button>
                                <button type="button" class="btn-reload-scan btn-reload-scan--icon-only button-with-icon" hidden aria-label="Recargar página" title="Recargar página">
                                    <span class="icon icon--sm icon-reload" aria-hidden="true"></span>
                                    <span class="sr-only">Recargar</span>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="serie">Serie:</label>
                            <div class="input-with-button">
                                <input type="text" id="serie" placeholder="Número de serie">
                                <button type="button" class="btn-scan button-with-icon" data-target-input="serie">
                                    <span class="icon icon--sm icon-scan" aria-hidden="true"></span>
                                    <span class="sr-only">Escanear serie</span>
                                </button>
                                <button type="button" class="btn-reload-scan btn-reload-scan--icon-only button-with-icon" hidden aria-label="Recargar página" title="Recargar página">
                                    <span class="icon icon--sm icon-reload" aria-hidden="true"></span>
                                    <span class="sr-only">Recargar</span>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="marca">Marca:</label>
                            <input type="text" id="marca" placeholder="Ej: Dell, HP...">
                        </div>
                        <div class="form-group">
                            <label for="modelo">Modelo:</label>
                            <input type="text" id="modelo" placeholder="Ej: Optiplex 7010">
                        </div>
                    </div>
                    <div class="form-group-full">
                        <label for="estado_equipo">Estado del Equipo:</label>
                        <input type="text" id="estado_equipo" placeholder="Describe la condición física">
                    </div>
                    <div class="form-group-full">
                        <label for="motivo_descarte">Motivo del Descarte (Evaluación):</label>
                        <input type="text" id="motivo_descarte" placeholder="Describe la falla técnica">
                    </div>
                    <button type="submit" id="btn-anadir-equipo" class="btn-principal button-with-icon">
                        <span class="icon icon--sm icon-plus" aria-hidden="true"></span>
                        <span class="button-label">Añadir Equipo</span>
                    </button>
                </form>

                <!-- Controles para cerrar la sesión y documentar observaciones generales -->
                <div class="finalizar-seccion">
                   <label for="observacion">Observación General:</label>
                   <textarea id="observacion" rows="3" placeholder="Añade cualquier observación relevante..."></textarea>
                   <button id="btn-finalizar-descarte" class="btn-finalizar button-with-icon">
                       <span class="icon icon--sm icon-check" aria-hidden="true"></span>
                       <span class="button-label">Finalizar Descarte</span>
                   </button>
               </div>

                <!-- Tabla resumen de los equipos agregados durante la sesión actual -->
                <div class="tabla-equipos-wrapper">
                    <h3>Equipos Registrados (<span id="contador-equipos">0</span>)</h3>
                    <div class="table-container">
                        <table id="tabla-equipos">
                            <thead>
                                <tr>
                                    <th>Nº</th>
                                    <th>Descripción</th>
                                    <th>Marbete</th>
                                    <th>Serie</th>
                                    <th>Marca</th>
                                    <th>Modelo</th>
                                    <th>Estado</th>
                                    <th>Motivo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para crear una nueva sesión de descarte -->
    <div id="modal-nueva-sesion" class="modal-overlay">
        <div class="modal-content">
            <button id="btn-cerrar-modal" class="modal-close-btn" type="button" aria-label="Cerrar modal">
                <span class="icon icon--sm icon-close-cancel" aria-hidden="true"></span>
            </button>
            <h2>Crear Nueva Sesión de Descarte</h2>
            <form id="form-nueva-sesion" novalidate>
                <label for="unidad_administrativa">Unidad Administrativa:</label>
                <input type="text" id="unidad_administrativa" placeholder="Introduce el nombre de la escuela" required>
                <label for="siace_code">Código SIACE:</label>
                <input type="text" id="siace_code" placeholder="Introduce el código de la escuela" required>
                <button type="submit" class="btn-principal button-with-icon">
                    <span class="icon icon--sm icon-plus" aria-hidden="true"></span>
                    <span class="button-label">Crear Sesión</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Modal genérico para confirmar acciones importantes -->
    <div id="modal-confirmacion" class="modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-title">¿Estás seguro?</h2>
            <p id="confirm-message">Esta acción no se puede deshacer.</p>
            <div class="modal-buttons">
                <button id="btn-confirmar-cancelar" class="btn-secondary button-with-icon">
                    <span class="icon icon--sm icon-close-cancel" aria-hidden="true"></span>
                    <span class="button-label">Cancelar</span>
                </button>
                <button id="btn-confirmar-aceptar" class="btn-danger button-with-icon">
                    <span class="icon icon--sm icon-check" aria-hidden="true"></span>
                    <span class="button-label">Aceptar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal que permite editar equipos previamente capturados -->
    <div id="modal-editar-equipo" class="modal-overlay">
        <div class="modal-content">
            <button id="btn-cerrar-modal-editar" class="modal-close-btn" type="button" aria-label="Cerrar modal">
                <span class="icon icon--sm icon-close-cancel" aria-hidden="true"></span>
            </button>
            <h2>Editar Equipo</h2>
            <div class="modal-form-container">
                <form id="form-editar-equipo" novalidate>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="edit-descripcion">Descripción:</label>
                            <input type="text" id="edit-descripcion">
                        </div>
                        <div class="form-group">
                            <label for="edit-marbete">Marbete:</label>
                            <div class="input-with-button">
                                <input type="text" id="edit-marbete">
                                <button type="button" class="btn-scan button-with-icon" data-target-input="edit-marbete">
                                    <span class="icon icon--sm icon-scan" aria-hidden="true"></span>
                                    <span class="sr-only">Escanear marbete</span>
                                </button>
                                <button type="button" class="btn-reload-scan btn-reload-scan--icon-only button-with-icon" hidden aria-label="Recargar página" title="Recargar página">
                                    <span class="icon icon--sm icon-reload" aria-hidden="true"></span>
                                    <span class="sr-only">Recargar</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit-serie">Serie:</label>
                            <div class="input-with-button">
                                <input type="text" id="edit-serie">
                                <button type="button" class="btn-scan button-with-icon" data-target-input="edit-serie">
                                    <span class="icon icon--sm icon-scan" aria-hidden="true"></span>
                                    <span class="sr-only">Escanear serie</span>
                                </button>
                                <button type="button" class="btn-reload-scan btn-reload-scan--icon-only button-with-icon" hidden aria-label="Recargar página" title="Recargar página">
                                    <span class="icon icon--sm icon-reload" aria-hidden="true"></span>
                                    <span class="sr-only">Recargar</span>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="edit-marca">Marca:</label>
                            <input type="text" id="edit-marca">
                        </div>
                        <div class="form-group">
                            <label for="edit-modelo">Modelo:</label>
                            <input type="text" id="edit-modelo">
                        </div>
                    </div>
                    <div class="form-group-full">
                        <label for="edit-estado_equipo">Estado del Equipo:</label>
                        <input type="text" id="edit-estado_equipo">
                    </div>
                    <div class="form-group-full">
                        <label for="edit-motivo_descarte">Motivo del Descarte:</label>
                        <input type="text" id="edit-motivo_descarte">
                    </div>
                    <div class="modal-buttons">
                        <button type="button" id="btn-editar-cancelar" class="btn-secondary button-with-icon">
                            <span class="icon icon--sm icon-close-cancel" aria-hidden="true"></span>
                            <span class="button-label">Cancelar</span>
                        </button>
                        <button type="submit" class="btn-principal button-with-icon">
                            <span class="icon icon--sm icon-check" aria-hidden="true"></span>
                            <span class="button-label">Aplicar</span>
                        </button>
                    </div>
                </form>
            </div>
            </div>
    </div>
    
    <!-- Contenedor para mostrar alertas breves al usuario -->
    <div id="toast-notification" class="toast">
        <span id="toast-message"></span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="js/config.js"></script>
    <script src="js/scanbot/ScanbotSDK.min.js"></script>
    <script src="js/scanbot/ScanbotSDK.ui2.min.js"></script>
    
    <script src="js/common.js" defer></script>
    <script src="js/descartes.js" defer></script>
</body>
</html>